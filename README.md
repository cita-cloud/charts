# charts

### Prerequisites
- Kubernetes 1.17+
- Helm 3.5.4

### Install Helm

Helm is a tool for managing Kubernetes charts. Charts are packages of pre-configured Kubernetes resources.

To install Helm, refer to the [Helm install guide](https://github.com/helm/helm#install) and ensure that the `helm` binary is in the `PATH` of your shell.

### Using Helm

Once you have installed the Helm client, you can deploy a Helm Chart into a Kubernetes cluster.

Please refer to the [Quick Start guide](https://helm.sh/docs/intro/quickstart/) if you wish to get running in just a few commands, otherwise the [Using Helm Guide](https://helm.sh/docs/intro/using_helm/) provides detailed instructions on how to use the Helm client to manage packages on your Kubernetes cluster.

Useful Helm Client Commands:
* Install a chart: `helm install test-chain cita-cloud-local-cluster`
* List your application: `helm list`
* Uninstall a chart: `helm unintall test-chain`

### docs of chart

generated by `helm-docs`:

```
docker run --rm -v "$(pwd):/helm-docs" jnorwood/helm-docs:latest
```

### introduce charts

cita-cloud-pvc - Create PVC for CITA-Cloud

```
helm install local-pvc ./cita-cloud-pvc
```

cita-cloud-local-cluster - Setup CITA-Cloud blockchain in one k8s cluster.

```
helm install test-chain ./cita-cloud-local-cluster
```

cita-cloud-config - Create a job to create/change config of CITA-Cloud blockchain in one k8s cluster

```
helm install increase-single ./cita-cloud-config --set config.action.type=increaseSingle --set config.action.increaseSingle.kmsPassword=123456

helm install decrease-single ./cita-cloud-config --set config.action.type=decreaseSingle

helm install clean ./cita-cloud-config --set config.action.type=clean
```

cita-cloud-eip - Create EIP for CITA-Cloud

```
$ helm install cita-cloud-eip ./cita-cloud-eip --set service.startIP=192.168.0.2 --set service.endIP=192.168.0.254
```

cita-cloud-porter-lb - Setup porter Loadbalancer for CITA-Cloud node

```
helm install test-chain-0-lb ./cita-cloud-porter-lb --set config.chainName=test-chain --set config.domain=node0 --set service.port=30000 --set service.eipName=cita-cloud-eip
```

cita-cloud-multi-cluster-node - Setup CITA-Cloud node in multi k8s cluster

1. create pvc in each k8s cluster
```
helm install local-pvc ./cita-cloud-pvc
```

2. init chain config in each k8s cluster
```
helm install init-multi ./cita-cloud-config --set config.action.type=initMulti --set config.chainName=test-chain --set config.action.initMulti.superAdmin=8f81961f263f45f88230375623394c9301c033e7 --set config.action.initMulti.kmsPasswordList="123456\,123456\,123456" --set config.action.initMulti.nodeList="192.168.10.123:40000:node0\,192.168.10.134:40000:node1\,192.168.10.135:40000:node2" --set pvcName=local-pvc
```

3. create a node in each k8s cluster 
```
# in first k8s cluster
helm install test-chain ./cita-cloud-multi-cluster-node --set config.chainName=test-chain --set config.domain=node0
# in second k8s cluster
helm install test-chain ./cita-cloud-multi-cluster-node --set config.chainName=test-chain --set config.domain=node1
# in third k8s cluster
helm install test-chain ./cita-cloud-multi-cluster-node --set config.chainName=test-chain --set config.domain=node2
```

increase node in multi cluster
```
# execute this command in each k8s cluster
helm install increase-multi ./cita-cloud-config --set config.action.type=increaseMulti --set config.chainName=test-chain --set config.action.increaseMulti.kmsPassword=123456 --set config.action.increaseMulti.node="192.168.10.136:40000:node3" --set pvcName=local-pvc

# in fourth k8s cluster
helm install test-chain ./cita-cloud-multi-cluster-node --set config.chainName=test-chain --set config.domain=node3

# you should restart the first three pod
```

decrease node(domain:node3) in multi cluster
```
# execute this command in each k8s cluster
helm install decrease-multi ./cita-cloud-config --set config.action.type=decreaseMulti --set config.chainName=test-chain --set config.action.decreaseMulti.domain=node3

# in fourth k8s cluster
helm uninstall test-chain

# you should restart the first three pod 
```